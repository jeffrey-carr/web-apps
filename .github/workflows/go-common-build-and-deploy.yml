name: Reusable Build & Deploy

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      tag:
        required: true
        type: string
      deploy:
        required: false
        type: boolean
        default: true
      # Generic way to handle "Special Steps" - verify where to put a secret file
      inject_file_path:
        required: false
        type: string
        description: 'Path to inject a secret file (e.g. ./apps/federation/backend/.oci/key.pem)'
    secrets:
      # Standard Secrets
      GHCR_PAT:
        required: true
      SSH_KEY:
        required: true
      MONGO_CONNECTION_URL:
        required: true
      # Optional Secret for the file injection
      INJECT_FILE_CONTENT:
        required: false

env:
  REGISTRY: ghcr.io

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Inject Secret File (Optional)
        if: ${{ inputs.inject_file_path != '' }}
        run: |
          DIR=$(dirname "${{ inputs.inject_file_path }}")
          mkdir -p "$DIR"
          echo "${{ secrets.INJECT_FILE_CONTENT }}" > "${{ inputs.inject_file_path }}"
          echo "âœ… Injected secret file at ${{ inputs.inject_file_path }}"

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ inputs.app_name }}/backend/Dockerfile
          push: true
          build-args: APP=${{ inputs.app_name }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-backend:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-backend:${{ inputs.tag }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate .env
        working-directory: ./apps/${{ inputs.app_name }}/frontend
        run: echo "PUBLIC_ENVIRONMENT=prod" > .env

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ inputs.app_name }}/frontend/Dockerfile
          push: true
          build-args: APP=${{ inputs.app_name }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-frontend:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-frontend:${{ inputs.tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: inputs.deploy == true
    steps:
      - name: SSH to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.SERVER_IP }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Use the input variable here
            APP="${{ inputs.app_name }}"

            # Standard deployment logic
            sudo mkdir -p /opt/apps/$APP/frontend
            sudo mkdir -p /opt/apps/$APP/backend
            sudo chown -R ${{ vars.SSH_USERNAME }}:${{ vars.SSH_USERNAME }} /opt/apps/$APP

            cat > /opt/apps/$APP/backend/.env.json << 'EOF'
            {
              "environment": "prod",
              "mongoConnectionURL": "${{ secrets.MONGO_CONNECTION_URL}}",
              "port": "${{ vars.PORT }}"
            }
            EOF

            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ vars.GHCR_USERNAME }} --password-stdin

            cd /opt/apps/$APP
            docker compose pull
            docker compose up -d
            docker image prune -f
