name: Reusable Build & Deploy

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      tag:
        required: true
        type: string
      deploy:
        required: false
        type: boolean
        default: true
      inject_file_path:
        required: false
        type: string
      environment_name:
        required: true
        type: string
    secrets:
      GHCR_PAT:
        required: true
      SSH_KEY:
        required: true
      INJECT_FILE_CONTENT:
        required: false
      ENV_FILE_CONTENT:
        required: true

env:
  REGISTRY: ghcr.io

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject Secret File
        if: ${{ inputs.inject_file_path != '' }}
        run: |
          DIR=$(dirname "${{ inputs.inject_file_path }}")
          mkdir -p "$DIR"
          echo "${{ secrets.INJECT_FILE_CONTENT }}" > "${{ inputs.inject_file_path }}"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ inputs.app_name }}/backend/Dockerfile
          push: true
          build-args: APP=${{ inputs.app_name }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-backend:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-backend:${{ inputs.tag }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Frontend .env
        working-directory: ./apps/${{ inputs.app_name }}/frontend
        run: echo "PUBLIC_ENVIRONMENT=prod" > .env

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ inputs.app_name }}/frontend/Dockerfile
          push: true
          build-args: APP=${{ inputs.app_name }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-frontend:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.app_name }}-frontend:${{ inputs.tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: inputs.deploy == true
    environment: ${{ inputs.environment_name }}
    steps:
      - name: SSH to server
        uses: appleboy/ssh-action@master
        env:
          APP_NAME: ${{ inputs.app_name }}
          ENV_CONTENT: ${{ secrets.ENV_FILE_CONTENT }}
        with:
          host: ${{ vars.SERVER_IP }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          envs: APP_NAME,ENV_CONTENT
          script: |
            set -e
            sudo mkdir -p /opt/apps/$APP_NAME/frontend
            sudo mkdir -p /opt/apps/$APP_NAME/backend
            sudo chown -R ${{ vars.SSH_USERNAME }}:${{ vars.SSH_USERNAME }} /opt/apps/$APP_NAME
            echo "$ENV_CONTENT" > /opt/apps/$APP_NAME/backend/.env
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ vars.GHCR_USERNAME }} --password-stdin
            cd /opt/apps/$APP_NAME
            docker compose pull
            docker compose up -d
            docker image prune -f
